on:
  workflow_dispatch:
  push:
    
env:
  APP_NAME: governor-api
  IMAGE_REPO: ghcr.io/metal-toolbox/governor-api

jobs:
  setup:
    name: âš™ï¸ setup
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.vars.outputs.image-tag }}
    steps:
      - id: vars
        run: |
          SHORT_SHA="${GITHUB_SHA:0:8}"
          echo "image-tag=${{ github.run_number }}-${SHORT_SHA}" >> $GITHUB_OUTPUT

  lint: 
    name: ðŸ“Ž lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version-file: 'go.mod'
      - uses: golangci/golangci-lint-action@1e7e51e771db61008b38414a730f564565cf7c20 #v9.2.0

  test:
    name: ðŸ§ª test
    runs-on: ubuntu-latest
    container: golang:1.25.7
    services:
      pg: 
        image: postgres:18
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: governor_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    env:
      GOVERNOR_DB_URI: postgresql://postgres:postgres@pg:5432/governor_test?sslmode=disable
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - name: tests
        run: make ci-test
        
  build-go:
    name: ðŸ—ï¸ build go
    runs-on: ubuntu-latest
    needs:
      - lint
      - test
    env:
      CGO_ENABLED: 0
      GOOS: linux
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version-file: 'go.mod'
      - name: build
        run: go build -buildvcs=false -mod=mod -a -o bin/${{ env.APP_NAME }}
      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: ${{ env.APP_NAME }}-bin
          path: bin/${{ env.APP_NAME }}

  build-docker:
    name: ðŸ³ build and publish docker image
    runs-on: ubuntu-latest
    needs:
      - build-go
      - setup
    permissions:
      contents: write
      id-token: write
      packages: write
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: sigstore/cosign-installer@v3.7.0
      - uses: docker/metadata-action@c299e40c65443455700f0fdfc63efafe5b349051 # v5.10.0
        id: meta
        with:
          images: ${{ env.IMAGE_REPO }}
      - name: login GHCR
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: ${{ env.APP_NAME }}-bin
          path: bin
      - name: build and push
        id: build-push
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
        with:
          context: .
          push: ${{ github.ref == 'refs/heads/main' }}
          load: true
          file: Dockerfile
          build-args: BIN=bin/${{ env.APP_NAME }}
          labels: ${{ steps.meta.outputs.labels }}
          tags: |
            ${{ steps.meta.outputs.tags }}
            ${{ env.IMAGE_REPO }}:${{ needs.setup.outputs.image_tag }}
      - name: Save image as tar for scanning
        run: docker save ${{ env.IMAGE_REPO }}:${{ needs.setup.outputs.image_tag }} -o image.tar
      - name: Upload image artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: docker-image
          path: image.tar
          retention-days: 1
      - name: sign image
        if: github.ref == 'refs/heads/main'
        run: cosign sign --yes ${{ env.IMAGE_REPO }}@${{ steps.build-push.outputs.digest }}

  trivy-scan:
    name: ðŸ” scan image
    runs-on: ubuntu-latest
    needs:
      - build-docker
      - setup
    permissions:
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - name: Download image artifact
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: docker-image
          path: .
      - name: full scan with Trivy
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8 # 0.33.1
        env:
          TRIVY_DEBUG: true
        with:
          input: 'image.tar'
          format: 'sarif'
          output: 'trivy-results.sarif'
          exit-code: '0'
      - name: fail with high critical
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8 # 0.33.1
        with:
          input: 'image.tar'
          format: 'table'
          severity: 'HIGH,CRITICAL'
          output: 'trivy-high-results.txt'
          exit-code: '1'
      - name: job summary
        run: |
          # step summary
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat trivy-high-results.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
      - name: Upload Trivy results to Security tab
        if: always()
        uses: github/codeql-action/upload-sarif@45cbd0c69e560cd9e7cd7f8c32362050c9b7ded2 # v4.32.2
        with:
          sarif_file: 'trivy-results.sarif'
